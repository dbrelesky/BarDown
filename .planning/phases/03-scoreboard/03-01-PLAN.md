---
phase: 03-scoreboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/App/Controllers/GameController.swift
autonomous: true
requirements: [SCOR-04]

must_haves:
  truths:
    - "A GET /api/v1/games/dates endpoint exists and returns an array of date strings"
    - "The endpoint accepts 'from' and 'to' query params in yyyy-MM-dd format"
    - "Only dates that have at least one game are returned"
    - "Date strings use America/New_York timezone boundary (consistent with gamesByDate)"
  artifacts:
    - path: "Sources/App/Controllers/GameController.swift"
      provides: "gameDates route handler registered at GET /api/v1/games/dates"
      contains: "gameDates"
  key_links:
    - from: "Sources/App/Controllers/GameController.swift"
      to: "Game Fluent model"
      via: "distinct startTime query filtered to from/to range"
      pattern: "Game\\.query.*filter.*startTime"
---

<objective>
Add a lightweight `GET /api/v1/games/dates` endpoint to the Vapor backend that returns an array of `yyyy-MM-dd` date strings for all days that have at least one game within a requested date range.

Purpose: The iOS date strip must show only dates with games (locked CONTEXT.md decision). Without this endpoint the app would need 60+ individual requests or a large-range over-fetch to discover which dates have games. This single query is the correct solution.

Output: One new route handler in GameController.swift. No new files required.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-scoreboard/03-RESEARCH.md

@Sources/App/Controllers/GameController.swift
@Sources/App/DTOs/GameResponse.swift
@Sources/App/routes.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET /api/v1/games/dates endpoint to GameController</name>
  <files>Sources/App/Controllers/GameController.swift</files>
  <action>
Add a new route handler `gameDates` to `GameController.boot(routes:)` and implement the handler function.

**Route registration** (add after the existing `games.get` lines in `boot`):
```swift
games.get("dates", use: gameDates)
```

**Handler implementation** (add after the existing `boxScore` function, before the private helpers):
```swift
@Sendable
func gameDates(req: Request) async throws -> [String] {
    let fromString = req.query[String.self, at: "from"]
    let toString = req.query[String.self, at: "to"]

    let formatter = DateFormatter()
    formatter.dateFormat = "yyyy-MM-dd"
    formatter.timeZone = TimeZone(identifier: "America/New_York")!

    var calendar = Calendar(identifier: .gregorian)
    calendar.timeZone = TimeZone(identifier: "America/New_York")!

    // Default: today ± 30 days
    let now = Date()
    let defaultFrom = calendar.date(byAdding: .day, value: -30, to: calendar.startOfDay(for: now))!
    let defaultTo = calendar.date(byAdding: .day, value: 31, to: calendar.startOfDay(for: now))!

    let from = fromString.flatMap { formatter.date(from: $0) } ?? defaultFrom
    let to = toString.flatMap { formatter.date(from: $0) }.map {
        calendar.date(byAdding: .day, value: 1, to: calendar.startOfDay(for: $0))!
    } ?? defaultTo

    let games = try await Game.query(on: req.db)
        .filter(\.$startTime >= from)
        .filter(\.$startTime < to)
        .field(\.$startTime)
        .all()

    // Extract unique Eastern-timezone date strings
    let uniqueDates = Set(games.map { formatter.string(from: $0.startTime) })
    return uniqueDates.sorted()
}
```

**Key constraints:**
- Uses the same `America/New_York` timezone as `dateBounds(for:)` — day boundaries are consistent
- Returns `[String]` (Vapor can encode String arrays as JSON directly via Content protocol)
- Deduplicates via `Set` before sorting — multiple games on the same date produce one entry
- Defaults to ±30 days if params omitted, matching the iOS date strip window
- Do NOT use `.unique()` Fluent operator — it has limited support across database drivers; use Set deduplication in Swift instead
  </action>
  <verify>
    <automated>swift build --package-path /Users/darrenbrelesky/Documents/claude-code/BarDown 2>&1 | tail -5</automated>
    <manual>After build: curl -s -H "X-API-Key: $BARDOWN_API_KEY" "http://localhost:8080/api/v1/games/dates" should return a JSON array (may be empty [] if no local data)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>
    `swift build` exits 0 with no errors. The `gameDates` function compiles and is registered at `GET /api/v1/games/dates`.
  </done>
</task>

</tasks>

<verification>
- `swift build` exits 0 (no compile errors in Vapor backend)
- `GET /api/v1/games/dates` route exists in the built binary (confirmed by `swift run App routes 2>&1 | grep dates`)
- Handler uses `America/New_York` timezone (grep: `America/New_York` appears in `gameDates` function)
- Handler returns `[String]` sorted array of `yyyy-MM-dd` strings
</verification>

<success_criteria>
The Vapor backend compiles clean and exposes `GET /api/v1/games/dates?from=yyyy-MM-dd&to=yyyy-MM-dd` returning a sorted `[String]` of date strings that have games. Defaults to ±30 day window. Timezone matches `gamesByDate` handler (America/New_York).
</success_criteria>

<output>
After completion, create `.planning/phases/03-scoreboard/03-01-SUMMARY.md`
</output>
