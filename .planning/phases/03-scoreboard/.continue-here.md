---
phase: 03-scoreboard
task: 7
total_tasks: 7
status: in_progress
last_updated: 2026-02-25T20:22:02.854Z
---

<current_state>
Phase 03 waves 1-4 are ALL COMPLETE (plans 03-01 through 03-06 done, committed).
Plan 03-07 is the human verification checkpoint — blocked because the backend scraper
was returning no data. The root cause has been identified and fixed (NCAA API migration)
but the fix has NOT been committed yet. The server is running locally but showing 0 games
in the database. Need to debug why the scraper isn't populating the DB despite the
build being clean.
</current_state>

<completed_work>

- Plan 03-01: Backend `GET /api/v1/games/dates` endpoint — DONE, committed
- Plan 03-02: iOS test suite RED phase (GameModelTests, ScoreboardViewModelTests, DateStripTests, fixture) — DONE, committed
- Plan 03-03: iOS GameModel, TeamModel, APIClient, GameEndpoint — DONE, committed
- Plan 03-04: ScoreboardViewModel, DateStripView, CalendarSheetView — DONE, committed (9 tests GREEN)
- Plan 03-05: TeamRowView, LiveIndicator, ScoreCenterView, GameCardView (Kingfisher) — DONE, committed
- Plan 03-06: ScoreboardView, ScoreboardStates, PullToRefreshView, ScoreboardTab wired — DONE, committed (23/23 tests pass)
- NCAA API investigation: Confirmed 2026 season started Jan 30. Casablanca API deprecated. Found NCAA GraphQL API (sdataprod.ncaa.com) with GetContests_web persisted query.
- Scraper rewrite: NCAAAPIScraper.swift rewritten to use NCAA GraphQL API. Build is clean. NOT YET COMMITTED.
</completed_work>

<remaining_work>

- Debug why scraper isn't populating DB (server running, build clean, but 0 games returned from API)
- Commit the scraper rewrite once confirmed working
- Plan 03-07: Human verification checkpoint — run app on iOS 26 simulator, verify checklist
- Mark Phase 03 complete via `/gsd:verify-work 3`
</remaining_work>

<decisions_made>

- **NCAA API choice**: User explicitly said NOT to use ESPN. Chose NCAA's own GraphQL API (sdataprod.ncaa.com) over ESPN.
- **Hash strategy**: Fetch the GetContests_web SHA-256 hash fresh from `ncaa.com/scoreboard/lacrosse-men/d1` HTML on each scraper boot. Cache as `nonisolated(unsafe) static var`. Auto-refresh on PERSISTED_QUERY_NOT_FOUND.
- **seasonYear**: NCAA uses academic-year start (2025-26 season → seasonYear=2025). Critical — using 2026 returns no data.
- **contestDate format**: Must be "MM/dd/yyyy" (not "yyyy/MM/dd" like old Casablanca).
- **gameState values**: "P" = scheduled, "F" = final, anything else = live.
- **Logo URL pattern**: `https://www.ncaa.com/sites/default/files/images/logos/schools/bgl/{seoname}.svg` — verified for all D1 lacrosse teams.
- **Conference seo mapping**: NCAA returns e.g. "big-ten" — replace hyphens with spaces so DataReconciler's conferenceNameMap ("big ten" → "B1G") works.
- **Logo propagation**: Added `homeLogoURL`/`awayLogoURL` to ScrapedGame struct, propagated through DataReconciler.resolveTeam and updateTeamMetadata.
</decisions_made>

<blockers>

- **Scraper not populating DB**: Server starts, build is clean, Vapor client HTTP calls to NCAA API appear to work via curl. But after 40+ seconds (>1 scrape cycle), DB still shows 0 games. Possible causes:
  1. The Vapor `app.client` GET request to ncaa.com scoreboard page (to fetch the hash) may be failing silently — the HTML page is large and may have a different response structure in Vapor vs curl.
  2. The `response.body.getString(at: body.readerIndex, length: body.readableBytes)` call might return nil (body not buffered).
  3. The `response.content.decode(GraphQLResponse.self)` for the GraphQL response might fail due to extra GraphQL fields not in the Codable struct.
  4. ScraperScheduler loop: scrapes per-conference but `fetchScoreboard(date:conference:)` filters by conference — today's games are CAA and MAAC (Stony Brook, Iona, Brown, UMass), none in Phase 1 conferences (ACC, Big East, Big Ten, Patriot, Ivy). So the scraper correctly finds 0 games for Phase 1 conferences today!

  **Most likely root cause #4**: Today (Feb 25) only has 2 games, both in CAA/MAAC. The Phase 1 conference filter in ScraperScheduler means no data gets stored. Need to either: (a) expand Phase 1 conferences or (b) scrape ALL conferences, not just Phase 1.
</blockers>

<context>
The whole phase was executed successfully — all iOS code is built and committed. The only
blocker is live data showing in the app. The scraper rewrite is architecturally correct;
the problem is likely that today happens to have no Phase 1 conference games. To test
with real data, either:

Option A (quick): Check a date with Phase 1 games (e.g. Feb 14 had 29 games, many ACC/B1G)
by changing the default date in the app temporarily.

Option B (correct fix): Change ScraperScheduler to scrape ALL conferences, not just Phase 1.
The Phase 1 filter was a Phase 1 scope decision but now that we have a working all-conference
API, we should store everything.

Option C (test now): Add a non-Phase-1 conference to the phase1Conferences array temporarily
(e.g. "CAA" / "CAA") to verify the scraper works end-to-end, then expand properly.

The 3 modified files that need committing:
- Sources/App/Scraper/NCAAAPIScraper.swift (full rewrite to GraphQL)
- Sources/App/Scraper/HTMLParsers/ScoreboardParser.swift (added homeLogoURL/awayLogoURL fields)
- Sources/App/Scraper/DataReconciler.swift (logoURL param in resolveTeam/updateTeamMetadata)
</context>

<next_action>
Start with: Check ScraperScheduler.phase1Conferences — if today's games are all non-Phase-1
conferences, add "CAA"/"CAA" temporarily to verify the scraper populates the DB. Then
commit the scraper rewrite, restart the server, confirm games appear, run the app on
iOS 26 simulator for plan 03-07 human verification.

Quick test command:
```bash
curl -s "https://sdataprod.ncaa.com/?meta=GetContests_web&..." # check Feb 14 (big game day)
# OR add CAA to ScraperScheduler.phase1Conferences temporarily
```
</next_action>
