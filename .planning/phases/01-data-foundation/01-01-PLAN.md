---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Package.swift
  - Sources/App/entrypoint.swift
  - Sources/App/configure.swift
  - Sources/App/routes.swift
  - Sources/App/Models/Conference.swift
  - Sources/App/Models/Team.swift
  - Sources/App/Models/Player.swift
  - Sources/App/Models/Game.swift
  - Sources/App/Models/QuarterScore.swift
  - Sources/App/Models/GameStats.swift
  - Sources/App/Models/PlayerGameStats.swift
  - Sources/App/Migrations/CreateConference.swift
  - Sources/App/Migrations/CreateTeam.swift
  - Sources/App/Migrations/CreatePlayer.swift
  - Sources/App/Migrations/CreateGame.swift
  - Sources/App/Migrations/CreateQuarterScore.swift
  - Sources/App/Migrations/CreateGameStats.swift
  - Sources/App/Migrations/CreatePlayerGameStats.swift
  - Sources/App/Migrations/SeedConferences.swift
  - docker-compose.yml
  - .env.development
  - Dockerfile
autonomous: true
requirements:
  - DATA-04

must_haves:
  truths:
    - "Vapor project compiles and runs locally with `swift run App serve`"
    - "PostgreSQL database is created with all tables via `swift run App migrate`"
    - "All 7 models (Conference, Team, Player, Game, QuarterScore, GameStats, PlayerGameStats) exist with correct relationships"
    - "Phase 1 conferences (Big East, ACC, Big Ten, Patriot League, Ivy League) are seeded into the database"
  artifacts:
    - path: "Package.swift"
      provides: "Swift package manifest with Vapor, Fluent, FluentPostgresDriver, SwiftSoup, VaporCron dependencies"
      contains: "vapor"
    - path: "Sources/App/Models/Game.swift"
      provides: "Game model with scores, status, period, clock, start time, external IDs"
      contains: "final class Game"
    - path: "Sources/App/Models/PlayerGameStats.swift"
      provides: "Player game stats with all lacrosse stats (goals, assists, shots, saves, ground balls, faceoffs, turnovers, penalties)"
      contains: "final class PlayerGameStats"
    - path: "docker-compose.yml"
      provides: "Local PostgreSQL container for development"
      contains: "postgres"
  key_links:
    - from: "Sources/App/configure.swift"
      to: "Sources/App/Migrations/*.swift"
      via: "app.migrations.add() calls registering all migrations in order"
      pattern: "app\\.migrations\\.add"
    - from: "Sources/App/Models/Game.swift"
      to: "Sources/App/Models/Team.swift"
      via: "@Parent relationship for homeTeam and awayTeam"
      pattern: "@Parent.*Team"
---

<objective>
Scaffold the Vapor 4 project with all Fluent data models, migrations, and local development infrastructure.

Purpose: Everything in Phase 1 (scrapers, API endpoints, deployment) depends on having the Swift package, database schema, and model layer in place. This plan creates the foundation that Plans 02 and 03 build on.

Output: A compiling Vapor project with 7 Fluent models, migrations that create all PostgreSQL tables, seeded conference data, and a docker-compose for local Postgres.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vapor project scaffold with Package.swift and core infrastructure</name>
  <files>
    Package.swift
    Sources/App/entrypoint.swift
    Sources/App/configure.swift
    Sources/App/routes.swift
    docker-compose.yml
    .env.development
    Dockerfile
  </files>
  <action>
Create a new Vapor 4 project from scratch (do NOT use `vapor new` — write files directly for full control).

**Package.swift:**
- Swift tools version 5.9+
- Dependencies: vapor 4.89+, fluent 4.8+, fluent-postgres-driver 2.7+, SwiftSoup 2.7+, VaporCron 2.6+
- Single target: App (with all dependencies linked)

**Sources/App/entrypoint.swift:**
- Standard Vapor @main entry point using `Vapor.Application`

**Sources/App/configure.swift:**
- Configure PostgreSQL database using Environment.get() for DATABASE_HOST, DATABASE_USERNAME, DATABASE_PASSWORD, DATABASE_NAME (fallback to docker-compose defaults: localhost/vapor/vapor/bardown)
- Register all migrations in dependency order: Conference → Team → Player → Game → QuarterScore → GameStats → PlayerGameStats → SeedConferences
- Call `try routes(app)` at the end
- TLS disabled for local dev (Railway will use DATABASE_URL connection string)
- Add DATABASE_URL parsing support: if DATABASE_URL env var exists, parse it as a PostgreSQL connection string (Railway provides this). Otherwise fall back to individual env vars.

**Sources/App/routes.swift:**
- Minimal placeholder: register a GET /health endpoint returning {"status": "ok"} for deployment health checks

**docker-compose.yml:**
- PostgreSQL 16 container: port 5432, user vapor, password vapor, database bardown
- Volume for data persistence

**.env.development:**
- DATABASE_HOST=localhost, DATABASE_USERNAME=vapor, DATABASE_PASSWORD=vapor, DATABASE_NAME=bardown

**Dockerfile:**
- Multi-stage build following Vapor's official Docker template for Linux (Ubuntu 22.04)
- Stage 1: swift:5.9-jammy for building
- Stage 2: ubuntu:jammy for runtime (copy built binary)
- Expose port 8080
- CMD ["App", "serve", "--env", "production", "--hostname", "0.0.0.0", "--port", "8080"]
  </action>
  <verify>
    <automated>cd /Users/darrenbrelesky/Documents/claude-code/BarDown && docker compose up -d && sleep 3 && swift build 2>&1 | tail -5</automated>
    <manual>Verify Package.swift has all 5 dependencies, docker-compose creates postgres container, project compiles without errors</manual>
  </verify>
  <done>Vapor project compiles successfully. Docker-compose starts PostgreSQL. Health endpoint is defined. Dockerfile exists for Railway deployment.</done>
</task>

<task type="auto">
  <name>Task 2: Create all Fluent models, migrations, and conference seed data</name>
  <files>
    Sources/App/Models/Conference.swift
    Sources/App/Models/Team.swift
    Sources/App/Models/Player.swift
    Sources/App/Models/Game.swift
    Sources/App/Models/QuarterScore.swift
    Sources/App/Models/GameStats.swift
    Sources/App/Models/PlayerGameStats.swift
    Sources/App/Migrations/CreateConference.swift
    Sources/App/Migrations/CreateTeam.swift
    Sources/App/Migrations/CreatePlayer.swift
    Sources/App/Migrations/CreateGame.swift
    Sources/App/Migrations/CreateQuarterScore.swift
    Sources/App/Migrations/CreateGameStats.swift
    Sources/App/Migrations/CreatePlayerGameStats.swift
    Sources/App/Migrations/SeedConferences.swift
  </files>
  <action>
Create all 7 Fluent models and their corresponding migrations. Follow Vapor 4 patterns: `final class` conforming to `Model, @unchecked Sendable`, use property wrappers (@ID, @Field, @Parent, @Children, @OptionalField, @Siblings).

**Conference model:**
- Fields: id (UUID), name (String), abbreviation (String), statBroadcastID (String, unique), ncaaID (String?, optional)
- Children: teams

**Team model:**
- Fields: id (UUID), name (String), abbreviation (String), mascot (String?), logoAssetName (String? — maps to bundled iOS asset), wins (Int, default 0), losses (Int, default 0), ranking (Int?, optional)
- Parent: conference
- Fields for external IDs: statBroadcastID (String?, optional, unique), ncaaID (String?, optional)
- Children: players, homeGames, awayGames

**Player model:**
- Fields: id (UUID), firstName (String), lastName (String), number (String?), position (String?)
- Parent: team

**Game model:**
- Fields: id (UUID), homeScore (Int, default 0), awayScore (Int, default 0), status (String — "scheduled"/"live"/"final"/"delayed"/"postponed"), period (String?), clock (String?), startTime (Date), season (Int — default 2026)
- External IDs: statBroadcastID (String?, optional), ncaaGameID (String?, optional)
- Parent: homeTeam (Team), awayTeam (Team)
- Children: quarterScores, playerStats
- Timestamp: updatedAt

**QuarterScore model:**
- Fields: id (UUID), quarter (Int — 1,2,3,4 + 5 for OT), homeScore (Int), awayScore (Int)
- Parent: game

**GameStats model (team-level totals per game):**
- Fields: id (UUID), isHome (Bool), goals (Int), assists (Int), shots (Int), shotsOnGoal (Int?), saves (Int), groundBalls (Int), faceoffsWon (Int), faceoffsLost (Int), turnovers (Int), penalties (Int), penaltyMinutes (Int?)
- Parent: game, team

**PlayerGameStats model (individual player stat line):**
- Fields: id (UUID), goals (Int), assists (Int), points (Int), shots (Int), shotsOnGoal (Int?), saves (Int?), groundBalls (Int?), faceoffsWon (Int?), faceoffsLost (Int?), turnovers (Int?), causedTurnovers (Int?), penalties (Int?), penaltyMinutes (Int?)
- Parent: game, player
- NOTE: Many fields are optional because not all players have all stat types (e.g., goalies have saves but not faceoffs)

**Migrations:** Each migration creates the table with proper column types, foreign key constraints, and indexes:
- Index on Game.startTime (for date-range queries)
- Index on Game.status (for filtering live games)
- Unique constraint on Conference.statBroadcastID
- Unique constraint on Team.statBroadcastID (when not null)
- Composite unique constraint on PlayerGameStats (game_id + player_id)

**SeedConferences migration:**
Seed the 5 Phase 1 conferences with nil StatBroadcast IDs (Plan 02 audit will discover and populate actual IDs):
- Big East: statBroadcastID = nil
- ACC: statBroadcastID = nil
- Big Ten: statBroadcastID = nil
- Patriot League: statBroadcastID = nil
- Ivy League: statBroadcastID = nil

Note: StatBroadcast conference IDs are unknown until the Plan 02 HTML/URL audit. Seeding with nil avoids hardcoding guesses that would need to be corrected later.

After creating all files, update configure.swift to register all migrations in the correct dependency order.
  </action>
  <verify>
    <automated>cd /Users/darrenbrelesky/Documents/claude-code/BarDown && swift build 2>&1 | tail -5 && swift run App migrate --yes 2>&1 | tail -10</automated>
    <manual>Verify all 8 tables exist in PostgreSQL (7 models + fluent migrations tracking table), conferences are seeded</manual>
  </verify>
  <done>All 7 models compile. All migrations run successfully creating 7 tables. 5 conferences are seeded. Foreign key relationships are correct (Game references Team, PlayerGameStats references Game and Player, etc.).</done>
</task>

</tasks>

<verification>
1. `swift build` completes without errors
2. `docker compose up -d` starts PostgreSQL
3. `swift run App migrate --yes` creates all tables
4. `swift run App serve` starts the server, GET /health returns {"status":"ok"}
5. Connect to Postgres and verify: 5 conferences exist, all tables have correct columns and foreign keys
</verification>

<success_criteria>
- Vapor project compiles and serves HTTP on port 8080
- PostgreSQL has all 7 tables with correct schema
- 5 conferences seeded with StatBroadcast IDs
- Docker-compose provides local dev database
- Dockerfile ready for Railway deployment
- All model relationships (Parent/Children) compile and are correctly wired
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
