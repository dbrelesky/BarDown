---
phase: 01-data-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/App/Middleware/APIKeyMiddleware.swift
  - Sources/App/Middleware/RateLimitMiddleware.swift
  - Sources/App/routes.swift
  - Sources/App/configure.swift
autonomous: true
gap_closure: true
requirements: [DATA-02, DATA-03, DATA-06]

must_haves:
  truths:
    - "API endpoints require a valid API key header to return data"
    - "Requests without a valid API key receive 401 Unauthorized"
    - "Excessive requests from a single source are rate-limited with 429 Too Many Requests"
    - "Health endpoint remains unauthenticated for Railway health checks"
    - "API key is read from environment variable, not hardcoded"
  artifacts:
    - path: "Sources/App/Middleware/APIKeyMiddleware.swift"
      provides: "API key authentication middleware"
      contains: "APIKeyMiddleware"
    - path: "Sources/App/Middleware/RateLimitMiddleware.swift"
      provides: "Rate limiting middleware"
      contains: "RateLimitMiddleware"
    - path: "Sources/App/routes.swift"
      provides: "Middleware applied to API route group"
      contains: "APIKeyMiddleware"
  key_links:
    - from: "Sources/App/routes.swift"
      to: "Sources/App/Middleware/APIKeyMiddleware.swift"
      via: "middleware applied to api/v1 route group"
      pattern: "grouped.*APIKeyMiddleware"
    - from: "Sources/App/routes.swift"
      to: "Sources/App/Middleware/RateLimitMiddleware.swift"
      via: "middleware applied to api/v1 route group"
      pattern: "grouped.*RateLimitMiddleware"
---

<objective>
Implement API security: API key authentication middleware and rate limiting for all /api/v1/* endpoints.

Purpose: DATA-06 requires API key authentication for the iOS client, rate limiting on all endpoints, and no secrets stored in the app binary. This requirement was mapped to Phase 1 in REQUIREMENTS.md but was never planned or implemented. The API currently has zero authentication -- anyone can access all endpoints.

Output: Two Vapor middleware structs protecting the API route group, with the health endpoint remaining open.
</objective>

<execution_context>
@/Users/darrenbrelesky/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrenbrelesky/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-03-SUMMARY.md
@.planning/phases/01-data-foundation/01-VERIFICATION.md

@Sources/App/routes.swift
@Sources/App/configure.swift
@Sources/App/Controllers/GameController.swift
@Sources/App/Controllers/TeamController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key and rate limit middleware</name>
  <files>
    Sources/App/Middleware/APIKeyMiddleware.swift
    Sources/App/Middleware/RateLimitMiddleware.swift
  </files>
  <action>
    Create `Sources/App/Middleware/` directory and two middleware files.

    **APIKeyMiddleware.swift:**
    - Create `struct APIKeyMiddleware: AsyncMiddleware`
    - In `respond(to:chainingTo:)`, check for `X-API-Key` header on the incoming request
    - Compare against `Environment.get("API_KEY")`. If no API_KEY env var is set, log a warning on first request and allow all traffic (development mode fallback so local dev works without setting the env var)
    - If API_KEY is set and the request header is missing or doesn't match, throw `Abort(.unauthorized, reason: "Invalid or missing API key")`
    - If valid, call `next.respond(to: request)`
    - Mark as `@Sendable` conformant

    **RateLimitMiddleware.swift:**
    - Create `final class RateLimitMiddleware: AsyncMiddleware` (class for shared mutable state, or use an actor-backed store)
    - Use an in-memory dictionary `[String: (count: Int, windowStart: Date)]` keyed by client IP (`req.peerAddress?.description ?? "unknown"`)
    - Allow 100 requests per 60-second sliding window per IP
    - If exceeded, throw `Abort(.tooManyRequests, reason: "Rate limit exceeded. Try again later.")`
    - Add `Retry-After: 60` header to 429 responses
    - Clean up stale entries periodically (every 100th request or similar) to prevent memory growth
    - Use a simple lock or actor to make the dictionary thread-safe (Vapor routes run on multiple event loops)
    - Mark as `@Sendable` conformant as needed
  </action>
  <verify>
    <automated>cd /Users/darrenbrelesky/Documents/claude-code/BarDown && swift build 2>&1 | tail -5</automated>
    <manual>Check that both middleware files exist and contain the expected structs</manual>
  </verify>
  <done>APIKeyMiddleware and RateLimitMiddleware compile and implement the specified behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Apply middleware to API routes</name>
  <files>
    Sources/App/routes.swift
    Sources/App/configure.swift
  </files>
  <action>
    **routes.swift:**
    - Keep the `/health` endpoint OUTSIDE any middleware group (must remain unauthenticated for Railway health checks)
    - Create a grouped route with both middleware: `let protected = app.grouped(RateLimitMiddleware()).grouped(APIKeyMiddleware())`
    - Register GameController and TeamController on the `protected` group instead of directly on `app`
    - Update: `try protected.register(collection: GameController())` and `try protected.register(collection: TeamController())`
    - Rate limiting goes first (outer) so rate-limited requests are rejected before API key validation

    **configure.swift:**
    - No changes needed unless middleware requires app-level configuration. The API_KEY is read from environment at request time via `Environment.get("API_KEY")`.
    - Add a comment in the MARK sections noting that API_KEY env var should be set in production (Railway environment variables).

    **docker-compose.yml (if it has environment section):**
    - Add `API_KEY=dev-test-key-bardown` to the app service environment for local development convenience. If docker-compose only has postgres, skip this.
  </action>
  <verify>
    <automated>cd /Users/darrenbrelesky/Documents/claude-code/BarDown && swift build 2>&1 | tail -5</automated>
    <manual>Verify routes.swift has health outside middleware group and controllers inside protected group</manual>
  </verify>
  <done>Health endpoint is unauthenticated. All /api/v1/* endpoints require X-API-Key header when API_KEY env var is set. Rate limiting applies to all API requests. swift build passes.</done>
</task>

</tasks>

<verification>
- `swift build` passes with zero errors
- `grep -rn "APIKeyMiddleware" Sources/` returns matches in Middleware file and routes.swift
- `grep -rn "RateLimitMiddleware" Sources/` returns matches in Middleware file and routes.swift
- Health endpoint (`/health`) is NOT inside any middleware group
- GameController and TeamController are registered on the protected group
</verification>

<success_criteria>
All /api/v1/* endpoints are protected by API key authentication and rate limiting. Health endpoint remains open. No secrets are hardcoded -- API key comes from environment variable. When API_KEY env var is not set (local dev), requests pass through with a logged warning.
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-05-SUMMARY.md`
</output>
